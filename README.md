# E-WiMill — текущее состояние проекта

## ESP32-S3 USB MSC + SD (конец этапа 2)

### Кратко

E-WiMill — это устройство на базе ESP32-S3, которое использует SD-карту как носитель данных и может работать:
- как USB-флешка (Mass Storage) для ПК или пульта станка
- как локальное файловое хранилище ESP для дальнейшей обработки и передачи данных

Ключевая цель проекта — безопасная передача файлов между ПК / станком и ESP, без повреждения файловой системы SD.

### Аппаратная конфигурация

- MCU: ESP32-S3
- SD-карта:
  - подключение: SPI (SDSPI)
  - стабильная частота: 20 MHz
  - файловая система: FAT32
- USB:
  - используется native USB ESP32-S3
  - устройство определяется как USB Mass Storage

### Архитектурный принцип (критически важный)

SD-карта никогда не используется одновременно:
- как USB-накопитель
- и как файловая система ESP

Любая попытка одновременного доступа ранее приводила к:
- RAW-дискам
- зависаниям Windows
- ресетам ESP
- повреждению данных

Поэтому в проекте реализована жесткая модель ручного переключения режимов.

## Режимы работы

### USB_ATTACHED — режим USB-флешки

Активируется командой:

```
usb attach
```

Поведение:
- SD-карта отдаётся наружу как USB Mass Storage
- ПК или пульт станка видит обычную флешку FAT32

Разрешено:
- чтение файлов
- запись файлов

Ограничения:
- ESP не имеет доступа к файловой системе
- любые файловые операции внутри ESP запрещены
- попытка выполнить файловую команду возвращает BUSY

Это сделано сознательно для защиты файловой системы.

### USB_DETACHED — режим локальной работы ESP

Активируется командой:

```
usb detach
```

Поведение:
- USB-накопитель отключается от хоста
- SD-карта монтируется внутрь ESP как /sdcard
- ESP получает полный файловый доступ

Доступные операции:
- ls
- info
- mkdir
- rm
- cat
- touch
- sdtest

В этом режиме USB-флешка недоступна для ПК/станка.

## Переключение режимов

Переключение строго ручное.
Автоматических таймеров и детекта активности нет.
Модель консервативная, но надёжная.

Последовательность:
1) usb detach → ESP монтирует SD
2) операции с файлами на ESP
3) usb attach → ESP отдаёт SD наружу как флешку

## Текущий статус реализации (конец этапа 2)

### Что работает стабильно

- USB Mass Storage корректно определяется системой
- флешка монтируется в Windows
- можно копировать файлы на SD и с SD
- ESP блокирует запись на SD, если она примонтирована в Windows
- после usb detach ESP снова видит файлы
- нет RAW-дисков, ресетов и повреждений данных

### Известные ограничения (принятые на этапе 2)

1) Задержка появления диска  
После команды usb attach диск может появляться в системе через 10–30 секунд

Причины:
- поведение Windows при инициализации MSC
- SCSI-опросы и проверка файловой системы
- консервативная логика attach без агрессивных оптимизаций

На текущем этапе считается допустимым.

2) Скорость передачи данных  
Типичная скорость:
- старт ~300 KB/s
- затем ~170–200 KB/s

Чтение и запись примерно одинаковые.

Ограничения обусловлены:
- SDSPI (SPI вместо SDMMC)
- частотой 20 MHz
- безопасной обработкой cache/flush

Оптимизация скорости осознанно отложена.

3) Частота SPI  
Частоты выше 20 MHz приводили к нестабильному монтированию SD внутри ESP

Используется 20 MHz как безопасное значение.

## Что сознательно НЕ реализовано

- автоматический attach/detach
- определение “читает ли станок флешку”
- одновременный доступ USB + ESP
- WebUI / Wi-Fi / WebDAV
- оптимизация скорости MSC

Это сделано намеренно, чтобы зафиксировать стабильную базу.

## Итог этапа 2 (MVP-02)

Этап USB-SD флешки завершён.

Проект имеет:
- устойчивую архитектуру
- предсказуемое поведение
- безопасную модель работы с файловой системой

Ограничения по скорости и времени attach признаны допустимыми для текущего этапа.

## Следующий этап (MVP-03)

### Wi-Fi передача файлов

Дальнейшее развитие:
- добавить Wi-Fi
- реализовать передачу файлов по воздуху только в режиме USB_DETACHED
- после передачи файлов пользователь вручную выполняет usb attach и использует устройство как флешку

Важно:
- USB-часть считается стабильной и не переписывается
- Wi-Fi и Web-доступ не должны влиять на MSC

## Ключевая фиксация состояния

USB-флешка на ESP32-S3 работает стабильно.
Скорость и задержка attach известны и приняты.
Следующий этап — расширение функциональности, а не исправление базы.
