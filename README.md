# E-WiMill / MVP-01 — SD Mount + Serial File Manager

ESP-IDF 5.5.1 проект для ESP32-S3 DevKit. Приложение монтирует SD-карту (SDSPI, FATFS), выводит состояние в Serial и предоставляет простой CLI для работы с файлами.
Флеш зафиксирована на 8 MB (кастомная таблица разделов `partitions.csv`).

## Подключение SD-модуля (SDSPI)

| Signal | Pin |
| --- | --- |
| CS | GPIO10 |
| SCK | GPIO12 |
| MOSI | GPIO11 |
| MISO | GPIO13 |
| VCC | 3.3V |
| GND | GND |

Питание строго 3.3V, провода максимально короткие. Карта должна быть отформатирована в FAT32. Желательно поставить развязку на питании SD-модуля (например, 100 нФ + 10–47 мкФ рядом с модулем).

### Частота SD SPI

- Частота по умолчанию: 10 MHz (`sd freq` покажет текущую).
- Поддерживаемые частоты: 10/20/26 MHz. Если видите ошибки записи/отвалы — снижайте до 10 MHz (или используйте меньшие частоты, если добавите их при необходимости) и перемонтируйте (команда сама перемонтирует при изменении частоты).

## Команды CLI (115200 8N1)

- `help` — подсказка
- `ls` — список файлов/папок в /sdcard
- `info` — общий/свободный объем
- `rm <name>` — удалить файл
- `mkdir <dir>` — создать папку
- `cat <name>` — вывести первые 256 байт (hex + ascii)
- `touch <name> <bytes>` — создать файл заданного размера (опция для тестов)
- `mount` — повторить попытку монтирования после исправления подключения
- `sd freq [kHz]` — показать/установить частоту SD SPI (10000/20000/26000)
- `sdtest [mb] [kHz] [buf N]` — записать и проверить файл (по умолчанию 10 MB, буфер 16384 байт; можно задать частоту и размер буфера)

## Сборка и прошивка

```bash
idf.py set-target esp32s3
idf.py build
idf.py -p COM12 flash monitor
```

## Поведение при старте

- Логирует пины SPI и пытается смонтировать `/sdcard`.
- При успехе: печатает имя карты, частоту (по умолчанию 10 MHz), общий/свободный объем, список корня. FATFS монтируется с allocation unit = 32 KB.
- При ошибке: выводит код ошибки и подсказку (питание 3.3V, CS/SCK/MOSI/MISO, FAT32). После исправления можно набрать `mount` в CLI без перезапуска прошивки.

По умолчанию самотест (`sdtest`) использует буфер 16384 байт; размер можно менять через аргумент `buf`.

## Типовые проблемы

- **Не монтируется SD**: проверьте питание 3.3V, общую землю, пины CS/SCK/MOSI/MISO, формат FAT32, короткие провода.
- **Периодические ошибки чтения/записи**: плохие контакты, длинные Dupont-провода, отсутствие развязки питания.
- **`rm` не удаляет**: команда работает только с файлами, для директорий используйте `mkdir`/`rmdir` (rmdir не реализован в MVP).
