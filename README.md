# E-WiMill

ESP32-S3 + SD (SDSPI) + USB MSC. Проект рассчитан на безопасную передачу файлов между ПК/станком и ESP без повреждения FAT32. В основе - жесткое разделение режимов доступа к SD.

## Статус

- Этап 1 (MVP-02): стабильный USB Mass Storage + локальные CLI операции с SD.
- Этап 2 (MVP-03A): Setup Mode с AP, Web UI, сохранением настроек и переходом в STA + mDNS.

## Аппаратная конфигурация

- MCU: ESP32-S3
- SD (SDSPI):
  - CS: GPIO10
  - MOSI: GPIO11
  - SCK: GPIO12
  - MISO: GPIO13
  - Частота: 20 MHz (стабильная)
  - ФС: FAT32
- USB: native USB ESP32-S3 (MSC)
- Кнопка Setup: GPIO21 (active-low, на GND, внутренняя подтяжка)
- RGB LED: GPIO48 (WS2812/NeoPixel, 1 светодиод)

## Ключевой принцип (критично)

SD-карта не используется одновременно:
- как USB-накопитель
- и как локальная файловая система ESP

Любая попытка совмещать доступ приводит к RAW/зависаниям/повреждению данных. Поэтому переключение только вручную.

## Этап 1 (MVP-02): USB MSC + CLI/VFS

### Что происходит при старте

1) Инициализируется SD в RAW режиме (SDSPI).
2) Запускается TinyUSB MSC.
3) Устройство сразу в режиме `USB_ATTACHED`.

### Режимы

- `USB_ATTACHED` - SD отдана ПК как флешка (FAT32). Локальные файловые операции ESP запрещены.
- `USB_DETACHED` - USB MSC отключен, SD примонтирована как `/sdcard` для ESP.

### Переключение режимов (CLI)

Через UART (115200):

- `usb status` - текущий режим
- `usb attach` - отдать SD наружу как флешку
- `usb detach` - отключить MSC, смонтировать `/sdcard`

### Файловые команды (только в USB_DETACHED)

- `ls [path]`
- `info`
- `mkdir <dir>`
- `rm <file>`
- `cat <file>` (первые 256 байт hex+ascii)
- `touch <file> <n>` (создать файл из n нулей, выполняется в фоне)
- `sdtest [mb] [kHz] [buf N]` (тест записи, выполняется в фоне)
- `sd freq [kHz]` (20/26 MHz)

Если USB_ATTACHED - команды возвращают BUSY.

### Последовательность работы (пример)

1) Включить питание -> устройство сразу как USB флешка.
2) На ПК копируем файлы.
3) Для локальной работы ESP: `usb detach`.
4) Команды `ls/info/touch/...` работают по `/sdcard`.
5) Вернуть флешку наружу: `usb attach`.

## Этап 2 (MVP-03A): Setup Mode + Wi-Fi

### Вход в Setup Mode

- Удерживать кнопку GPIO21 >= 5 сек при старте, или
- Удерживать кнопку GPIO21 >= 5 сек в normal режиме.

### Поведение в Setup Mode

- Поднимается AP `E-WiMill-XXXX` (XXXX = последние 2 байта MAC).
- Пароль: `wimill1234`.
- IP: `192.168.4.1`.
- Web UI: `http://192.168.4.1:<port>` (по умолчанию `8080`).
- RGB LED: отдельный узнаваемый режим (пульсация). В normal режиме - медленное дыхание цветом (6,87,33).

### UI и API

- `GET /` - страница Setup.
- `GET /api/status` - JSON статуса (mode, ssid, sta_ip, last_sta_ip, rssi, web_port и т.д.).
- `POST /api/config` - сохраняет настройки в NVS.

### Переход AP -> STA (Apply)

Поток:

1) Нажать Apply -> конфиг сохраняется.
2) STA подключение стартует, AP остается активным (AP+STA).
3) Если подключение успешно:
   - Поднимается mDNS: `http://<dev_name>.local:<port>`
   - AP выключается
4) Если ошибка (таймаут 30 сек): остаемся в AP, в статусе появляется `sta_error`.

### mDNS имя

- dev_name нормализуется: нижний регистр, пробелы/`_` -> `-`, только `a-z0-9-`.
- Если имя пустое - fallback `ewimill-XXXX`.

### Где хранятся настройки

NVS (namespace `wimill`). Настройки переживают перепрошивку. Для сброса - `idf.py erase-flash`.

## Сборка и прошивка

```bash
idf.py set-target esp32s3
idf.py build
idf.py -p COMx flash monitor
```

## Примечания

- Скорость MSC ограничена SDSPI (типично ~170-300 KB/s).
- Частоты выше 20 MHz могут быть нестабильны.
- В проект добавлен `components/mdns`, чтобы mDNS работал в IDF 5.5.1.
